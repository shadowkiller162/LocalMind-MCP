<!-- AI å°è©±çµ„ä»¶ -->
<div class="card border-primary" id="ai-chat-widget">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h6 class="card-title mb-0">
      <i class="fas fa-robot me-2 text-primary"></i>
      AI åŠ©æ‰‹å°è©±
    </h6>
    <div class="chat-status">
      <span id="chat-status-badge" class="badge bg-success ready">
        <i class="fas fa-circle me-1"></i>å°±ç·’
      </span>
    </div>
  </div>
  
  <!-- å°è©±æ­·å²å€åŸŸ -->
  <div class="card-body p-0">
    <!-- å›æ‡‰é€²åº¦æ¢ -->
    <div id="response-progress" class="response-progress" style="display: none;">
      <div id="response-progress-bar" class="response-progress-bar"></div>
    </div>
    
    <div id="chat-messages" class="chat-messages-container">
      <!-- æ­¡è¿è¨Šæ¯ -->
      <div class="message-wrapper assistant-message">
        <div class="message-avatar">
          <i class="fas fa-robot text-primary"></i>
        </div>
        <div class="message-content">
          <div class="message-bubble">
            <p class="mb-1">ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ LocalMind-MCP AI åŠ©æ‰‹ã€‚</p>
            <p class="mb-0">æˆ‘å¯ä»¥å”åŠ©æ‚¨ç®¡ç† MCP æœå‹™ã€å›ç­”å•é¡Œæˆ–é€²è¡Œå°è©±æ¸¬è©¦ã€‚è«‹è¼¸å…¥æ‚¨çš„è¨Šæ¯ï¼</p>
          </div>
          <small class="message-time text-muted">ç³»çµ±è¨Šæ¯</small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- è¼¸å…¥å€åŸŸ -->
  <div class="card-footer">
    <form id="chat-form" 
          hx-post="{% url 'mcp_management:chat_send' %}"
          hx-target="#chat-messages"
          hx-swap="beforeend"
          hx-trigger="submit"
          hx-indicator="#send-spinner">
      {% csrf_token %}
      
      <div class="input-group">
        <input type="text" 
               name="message" 
               id="chat-input"
               class="form-control" 
               placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯..."
               autocomplete="off"
               required>
        
        <button type="submit" 
                class="btn btn-primary" 
                id="send-button">
          <span id="send-spinner" class="spinner-border spinner-border-sm me-2 d-none"></span>
          <i id="send-icon" class="fas fa-paper-plane"></i>
          <span id="send-text" class="d-none">ç™¼é€ä¸­</span>
        </button>
      </div>
      
      <!-- å¿«é€Ÿå›è¦†é¸é … -->
      <div class="quick-replies mt-2">
        <small class="text-muted me-2">å¿«é€Ÿå›è¦†:</small>
        <button type="button" class="btn btn-outline-secondary btn-sm me-1" 
                onclick="sendQuickMessage('æª¢æŸ¥ MCP ç‹€æ…‹')">
          æª¢æŸ¥ç‹€æ…‹
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm me-1" 
                onclick="sendQuickMessage('ä»‹ç´¹ LocalMind-MCP åŠŸèƒ½')">
          ç³»çµ±ä»‹ç´¹
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" 
                onclick="sendQuickMessage('å¦‚ä½•ä½¿ç”¨ MCP é€£æ¥å™¨ï¼Ÿ')">
          ä½¿ç”¨èªªæ˜
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// AI å°è©±çµ„ä»¶ JavaScript - å¢å¼·ç‰ˆ
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const sendButton = document.getElementById('send-button');
    const sendSpinner = document.getElementById('send-spinner');
    const sendIcon = document.getElementById('send-icon');
    const sendText = document.getElementById('send-text');
    const statusBadge = document.getElementById('chat-status-badge');
    const progressContainer = document.getElementById('response-progress');
    const progressBar = document.getElementById('response-progress-bar');
    
    let requestStartTime = null;
    let progressInterval = null;
    let thinkingIndicator = null;
    
    // é ä¼°å›æ‡‰æ™‚é–“ï¼ˆåŸºæ–¼è¨Šæ¯é•·åº¦ï¼‰
    function estimateResponseTime(messageLength) {
        // åŸºæœ¬æ™‚é–“ 2-5 ç§’ï¼Œé•·è¨Šæ¯å¢åŠ æ™‚é–“
        const baseTime = 2000;
        const lengthFactor = Math.min(messageLength * 50, 3000);
        return baseTime + lengthFactor;
    }
    
    // é¡¯ç¤º AI æ€è€ƒæŒ‡ç¤ºå™¨
    function showThinkingIndicator() {
        thinkingIndicator = document.createElement('div');
        thinkingIndicator.className = 'ai-thinking-indicator';
        thinkingIndicator.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot text-primary"></i>
            </div>
            <div class="ai-thinking-bubble">
                <span class="ai-thinking-text">AI æ­£åœ¨æ€è€ƒä¸­</span>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <span class="estimated-time" id="estimated-time"></span>
            </div>
        `;
        chatMessages.appendChild(thinkingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // éš±è— AI æ€è€ƒæŒ‡ç¤ºå™¨
    function hideThinkingIndicator() {
        if (thinkingIndicator) {
            thinkingIndicator.remove();
            thinkingIndicator = null;
        }
    }
    
    // æ›´æ–°é€²åº¦æ¢
    function updateProgress(estimatedTime) {
        let progress = 0;
        const increment = 100 / (estimatedTime / 100);
        
        progressInterval = setInterval(() => {
            progress += increment * (0.3 + Math.random() * 0.4); // éš¨æ©ŸåŒ–é€²åº¦å¢é•·
            progress = Math.min(progress, 95); // æœ€å¤šåˆ° 95%ï¼Œç­‰å¾…å¯¦éš›å›æ‡‰
            
            progressBar.style.width = progress + '%';
            
            // æ›´æ–°é ä¼°æ™‚é–“
            const elapsed = Date.now() - requestStartTime;
            const remaining = Math.max(0, estimatedTime - elapsed);
            const estimatedTimeElement = document.getElementById('estimated-time');
            if (estimatedTimeElement) {
                estimatedTimeElement.textContent = `é ä¼° ${Math.ceil(remaining / 1000)} ç§’`;
            }
        }, 100);
    }
    
    // å®Œæˆé€²åº¦æ¢
    function completeProgress() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        
        progressBar.style.width = '100%';
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }, 500);
    }
    
    // è¨­ç½®ç™¼é€ç‹€æ…‹
    function setSendingState(isSending) {
        if (isSending) {
            sendButton.disabled = true;
            sendButton.classList.add('sending');
            chatInput.disabled = true;
            
            sendSpinner.classList.remove('d-none');
            sendIcon.classList.add('d-none');
            sendText.classList.remove('d-none');
            
            statusBadge.className = 'badge bg-warning processing';
            statusBadge.innerHTML = '<i class="fas fa-circle me-1"></i>è™•ç†ä¸­';
        } else {
            sendButton.disabled = false;
            sendButton.classList.remove('sending');
            chatInput.disabled = false;
            
            sendSpinner.classList.add('d-none');
            sendIcon.classList.remove('d-none');
            sendText.classList.add('d-none');
            
            statusBadge.className = 'badge bg-success ready';
            statusBadge.innerHTML = '<i class="fas fa-circle me-1"></i>å°±ç·’';
        }
    }
    
    // è«‹æ±‚é–‹å§‹å‰
    chatForm.addEventListener('htmx:beforeRequest', function(event) {
        const messageLength = chatInput.value.trim().length;
        const estimatedTime = estimateResponseTime(messageLength);
        
        requestStartTime = Date.now();
        setSendingState(true);
        
        // é¡¯ç¤ºé€²åº¦æ¢
        progressContainer.style.display = 'block';
        updateProgress(estimatedTime);
        
        // å»¶é²é¡¯ç¤ºæ€è€ƒæŒ‡ç¤ºå™¨ï¼Œé¿å…çŸ­æ™‚é–“è«‹æ±‚çš„é–ƒçˆ
        setTimeout(() => {
            if (requestStartTime) { // ç¢ºä¿è«‹æ±‚é‚„åœ¨é€²è¡Œä¸­
                showThinkingIndicator();
            }
        }, 1000);
    });
    
    // è«‹æ±‚å®Œæˆå¾Œ
    chatForm.addEventListener('htmx:afterRequest', function(event) {
        requestStartTime = null;
        setSendingState(false);
        completeProgress();
        hideThinkingIndicator();
        
        if (event.detail.successful) {
            chatInput.value = '';
            chatInput.focus();
            
            // æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
    });
    
    // è«‹æ±‚éŒ¯èª¤è™•ç†
    chatForm.addEventListener('htmx:responseError', function(event) {
        requestStartTime = null;
        setSendingState(false);
        completeProgress();
        hideThinkingIndicator();
        
        statusBadge.className = 'badge bg-danger';
        statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>éŒ¯èª¤';
        
        // 3 ç§’å¾Œæ¢å¾©å°±ç·’ç‹€æ…‹
        setTimeout(() => {
            statusBadge.className = 'badge bg-success ready';
            statusBadge.innerHTML = '<i class="fas fa-circle me-1"></i>å°±ç·’';
        }, 3000);
    });
    
    // Enter éµæäº¤ (Shift+Enter æ›è¡Œ)
    chatInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            if (!sendButton.disabled) {
                chatForm.requestSubmit();
            }
        }
    });
    
    // åˆå§‹èšç„¦
    chatInput.focus();
});

// å¿«é€Ÿè¨Šæ¯ç™¼é€
function sendQuickMessage(message) {
    const chatInput = document.getElementById('chat-input');
    const chatForm = document.getElementById('chat-form');
    
    chatInput.value = message;
    chatForm.requestSubmit();
}

// æ¸…ç©ºå°è©±æ­·å²
function clearChatHistory() {
    const chatMessages = document.getElementById('chat-messages');
    // ä¿ç•™æ­¡è¿è¨Šæ¯
    const welcomeMessage = chatMessages.querySelector('.assistant-message');
    chatMessages.innerHTML = '';
    if (welcomeMessage) {
        chatMessages.appendChild(welcomeMessage);
    }
}
</script>