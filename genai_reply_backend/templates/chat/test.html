{% extends "base.html" %}

{% load static %}

{% block title %}
  AI å°è©±æ¸¬è©¦
{% endblock title %}
{% block css %}
  <style>
    .chat-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .auth-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }

    .chat-section {
      background: white;
      padding: 20px;
      border-radius: 6px;
      border-left: 4px solid #28a745;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .messages-container {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      margin: 15px 0;
      background: #fff;
      border-radius: 4px;
    }

    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 6px;
    }

    .message.user {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
    }

    .message.ai {
      background: #f3e5f5;
      border-left: 4px solid #9c27b0;
    }

    .message.system {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      font-style: italic;
    }

    .message-header {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      color: #666;
    }

    .message-content {
      line-height: 1.4;
      word-wrap: break-word;
    }

    .conversations-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }

    .conversation-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      background: white;
    }

    .conversation-item:hover {
      background: #f5f5f5;
    }

    .conversation-item.active {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
    }

    .hidden {
      display: none;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
{% endblock css %}
{% block content %}
  <div class="chat-container">
    <h1>ğŸ¤– LocalMind-MCP AI å°è©±æ¸¬è©¦</h1>
    <!-- èªè­‰å€å¡Š -->
    <div class="auth-section">
      <h3>ğŸ” ä½¿ç”¨è€…èªè­‰</h3>
      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" placeholder="è«‹è¼¸å…¥ email" />
      </div>
      <div class="form-group">
        <label for="password">å¯†ç¢¼:</label>
        <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
      </div>
      <button class="btn btn-primary" onclick="login()">ç™»å…¥</button>
      <button class="btn btn-info" onclick="checkAIStatus()">æª¢æŸ¥ AI ç‹€æ…‹</button>
      <button class="btn btn-warning" onclick="clearTokens()">æ¸…é™¤ Token</button>
      <div id="auth-status"></div>
    </div>
    <!-- å°è©±å€å¡Š -->
    <div class="chat-section hidden" id="chat-section">
      <h3>ğŸ’¬ AI å°è©±æ¸¬è©¦</h3>
      <!-- å°è©±ç®¡ç† -->
      <div class="form-group">
        <label>å°è©±ç®¡ç†:</label>
        <button class="btn btn-success" onclick="createConversation()">å»ºç«‹æ–°å°è©±</button>
        <button class="btn btn-info" onclick="loadConversations()">è¼‰å…¥å°è©±åˆ—è¡¨</button>
      </div>
      <!-- å°è©±åˆ—è¡¨ -->
      <div id="conversations-container" class="hidden">
        <label>ç¾æœ‰å°è©±:</label>
        <div id="conversations-list" class="conversations-list"></div>
      </div>
      <!-- ç•¶å‰å°è©±è³‡è¨Š -->
      <div id="current-conversation" class="hidden">
        <h4>
          ç•¶å‰å°è©±: <span id="conversation-title"></span>
        </h4>
        <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="messages-container" class="messages-container"></div>
        <!-- è¼¸å…¥å€ -->
        <div class="form-group">
          <label for="message-input">è¼¸å…¥è¨Šæ¯:</label>
          <textarea id="message-input" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨æƒ³èªªçš„è©±..."></textarea>
        </div>
        <button class="btn btn-success" onclick="sendMessage()" id="send-btn">ç™¼é€è¨Šæ¯</button>
        <button class="btn btn-warning" onclick="deleteConversation()">åˆªé™¤å°è©±</button>
      </div>
      <div id="chat-status"></div>
    </div>
  </div>
{% endblock content %}
{% block javascript %}
  <script>
    // å…¨åŸŸè®Šæ•¸
    let authToken = localStorage.getItem('authToken');
    let currentConversationId = null;
    let conversations = [];

    // API åŸºç¤è¨­å®š
    const API_BASE = '/api';
    const headers = {
      'Content-Type': 'application/json',
    };

    // æ›´æ–°èªè­‰ header
    function updateAuthHeaders() {
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      } else {
        delete headers['Authorization'];
      }
    }

    // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    function showStatus(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // ç™»å…¥åŠŸèƒ½
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showStatus('auth-status', 'è«‹è¼¸å…¥ email å’Œå¯†ç¢¼', 'error');
        return;
      }

      try {
        showStatus('auth-status', 'ç™»å…¥ä¸­...', 'info');

        // æ¸…é™¤èˆŠ token
        localStorage.removeItem('authToken');
        authToken = null;
        delete headers['Authorization'];

        const response = await fetch(`${API_BASE}/users/auth/login/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password
          })
        });

        const result = await response.json();

        if (response.ok) {
          authToken = result.data.access;
          localStorage.setItem('authToken', authToken);
          updateAuthHeaders();

          showStatus('auth-status', `ç™»å…¥æˆåŠŸï¼æ­¡è¿ ${result.data.user.display_name || result.data.user.email}`, 'success');
          document.getElementById('chat-section').classList.remove('hidden');

          // è‡ªå‹•è¼‰å…¥å°è©±åˆ—è¡¨
          await loadConversations();
        } else {
          // æ›´è©³ç´°çš„éŒ¯èª¤è™•ç†
          const errorMsg = result.detail || result.message || result.error || 'ç™»å…¥å¤±æ•—';
          showStatus('auth-status', `ç™»å…¥å¤±æ•—: ${errorMsg}`, 'error');
          console.error('Login error:', result);
        }
      } catch (error) {
        showStatus('auth-status', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
        console.error('Network error:', error);
      }
    }

    // æ¸…é™¤ Token åŠŸèƒ½
    function clearTokens() {
      localStorage.removeItem('authToken');
      authToken = null;
      delete headers['Authorization'];
      document.getElementById('chat-section').classList.add('hidden');
      showStatus('auth-status', 'Token å·²æ¸…é™¤ï¼Œè«‹é‡æ–°ç™»å…¥', 'info');
    }

    // æª¢æŸ¥ AI æœå‹™ç‹€æ…‹
    async function checkAIStatus() {
      try {
        showStatus('auth-status', 'æª¢æŸ¥ AI æœå‹™ç‹€æ…‹...', 'info');

        const response = await fetch(`${API_BASE}/core/ai/status/`, {
          headers: headers
        });

        const result = await response.json();

        if (response.ok) {
          const services = result.data.services || {};
          const serviceList = Object.entries(services)
            .map(([name, available]) => `${name}: ${available ? 'âœ…' : 'âŒ'}`)
            .join(', ');

          showStatus('auth-status', `AI æœå‹™ç‹€æ…‹: ${serviceList}`, 'success');
        } else {
          showStatus('auth-status', `ç„¡æ³•å–å¾— AI ç‹€æ…‹: ${result.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        }
      } catch (error) {
        showStatus('auth-status', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    // å»ºç«‹æ–°å°è©±
    async function createConversation() {
      if (!authToken) {
        showStatus('chat-status', 'è«‹å…ˆç™»å…¥', 'error');
        return;
      }

      const title = prompt('è«‹è¼¸å…¥å°è©±æ¨™é¡Œ:') || `å°è©± ${new Date().toLocaleString()}`;

      try {
        showStatus('chat-status', 'å»ºç«‹å°è©±ä¸­...', 'info');

        const response = await fetch(`${API_BASE}/core/conversations/`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            title
          })
        });

        const data = await response.json();

        if (response.ok) {
          showStatus('chat-status', `å°è©±å»ºç«‹æˆåŠŸ: ${data.title}`, 'success');
          currentConversationId = data.id;

          // æ›´æ–°ç•¶å‰å°è©±é¡¯ç¤º
          document.getElementById('conversation-title').textContent = data.title;
          document.getElementById('current-conversation').classList.remove('hidden');
          document.getElementById('messages-container').innerHTML = '';

          // é‡æ–°è¼‰å…¥å°è©±åˆ—è¡¨
          await loadConversations();
        } else {
          showStatus('chat-status', `å»ºç«‹å°è©±å¤±æ•—: ${data.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        }
      } catch (error) {
        showStatus('chat-status', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    // è¼‰å…¥å°è©±åˆ—è¡¨
    async function loadConversations() {
      if (!authToken) {
        showStatus('chat-status', 'è«‹å…ˆç™»å…¥', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/core/conversations/`, {
          headers: headers
        });

        const data = await response.json();

        if (response.ok) {
          conversations = data.results || data;

          const listContainer = document.getElementById('conversations-list');
          listContainer.innerHTML = '';

          if (conversations.length > 0) {
            conversations.forEach(conv => {
              const item = document.createElement('div');
              item.className = 'conversation-item';
              if (conv.id === currentConversationId) {
                item.classList.add('active');
              }
              item.innerHTML = `
            <strong>${conv.title}</strong><br />
            <small>å»ºç«‹æ™‚é–“: ${new Date(conv.created_at).toLocaleString()}</small>
          `;
              item.onclick = () => selectConversation(conv);
              listContainer.appendChild(item);
            });

            document.getElementById('conversations-container').classList.remove('hidden');
          } else {
            showStatus('chat-status', 'å°šç„¡å°è©±ï¼Œè«‹å»ºç«‹æ–°å°è©±', 'info');
          }
        } else {
          showStatus('chat-status', `è¼‰å…¥å°è©±å¤±æ•—: ${data.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        }
      } catch (error) {
        showStatus('chat-status', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    // é¸æ“‡å°è©±
    async function selectConversation(conversation) {
      currentConversationId = conversation.id;

      // æ›´æ–° UI
      document.getElementById('conversation-title').textContent = conversation.title;
      document.getElementById('current-conversation').classList.remove('hidden');

      // æ›´æ–°åˆ—è¡¨æ¨£å¼
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.conversation-item').classList.add('active');

      // è¼‰å…¥å°è©±å…§å®¹
      await loadMessages();
    }

    // è¼‰å…¥è¨Šæ¯
    async function loadMessages() {
      if (!currentConversationId) return;

      try {
        const response = await fetch(`${API_BASE}/core/conversations/${currentConversationId}/context/`, {
          headers: headers
        });

        const result = await response.json();

        if (response.ok) {
          const messagesContainer = document.getElementById('messages-container');
          messagesContainer.innerHTML = '';

          if (result.data.context_messages && result.data.context_messages.length > 0) {
            result.data.context_messages.forEach(msg => {
              addMessageToUI(msg.content, msg.sender, msg.timestamp);
            });
          } else {
            messagesContainer.innerHTML = '<div class="message system"><div class="message-content">é–‹å§‹æ–°å°è©±...</div></div>';
          }

          // æ»¾å‹•åˆ°åº•éƒ¨
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      } catch (error) {
        showStatus('chat-status', `è¼‰å…¥è¨Šæ¯å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      if (!authToken || !currentConversationId) {
        showStatus('chat-status', 'è«‹å…ˆç™»å…¥ä¸¦é¸æ“‡å°è©±', 'error');
        return;
      }

      const messageInput = document.getElementById('message-input');
      const content = messageInput.value.trim();

      if (!content) {
        showStatus('chat-status', 'è«‹è¼¸å…¥è¨Šæ¯å…§å®¹', 'error');
        return;
      }

      // ç¦ç”¨ç™¼é€æŒ‰éˆ•
      const sendBtn = document.getElementById('send-btn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'ç™¼é€ä¸­...';

      try {
        // å…ˆé¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
        addMessageToUI(content, 'user');
        messageInput.value = '';

        // ç™¼é€åˆ°å¾Œç«¯
        const response = await fetch(`${API_BASE}/core/conversations/${currentConversationId}/messages/`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            content
          })
        });

        const data = await response.json();

        if (response.ok) {
          showStatus('chat-status', 'è¨Šæ¯ç™¼é€æˆåŠŸï¼Œç­‰å¾… AI å›è¦†...', 'success');

          // è¼ªè©¢ç­‰å¾… AI å›è¦†
          await pollForAIResponse();
        } else {
          showStatus('chat-status', `ç™¼é€å¤±æ•—: ${data.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        }
      } catch (error) {
        showStatus('chat-status', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
      } finally {
        // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•
        sendBtn.disabled = false;
        sendBtn.textContent = 'ç™¼é€è¨Šæ¯';
      }
    }

    // è¼ªè©¢ AI å›è¦†
    async function pollForAIResponse() {
      let attempts = 0;
      const maxAttempts = 30; // 30ç§’

      const poll = async () => {
        try {
          const response = await fetch(`${API_BASE}/core/conversations/${currentConversationId}/context/`, {
            headers: headers
          });

          const result = await response.json();

          if (response.ok && result.data.context_messages) {
            const messagesContainer = document.getElementById('messages-container');
            const currentUIMessageCount = messagesContainer.children.length - 1; // æ¸›å»systemè¨Šæ¯
            const serverMessageCount = result.data.context_messages.length;

            // å¦‚æœæœå‹™ç«¯è¨Šæ¯æ•¸é‡æ¯”UIæ›´å¤šï¼Œèªªæ˜æœ‰æ–°è¨Šæ¯
            if (serverMessageCount > currentUIMessageCount) {
              // é‡æ–°è¼‰å…¥æ‰€æœ‰è¨Šæ¯ä»¥ç¢ºä¿åŒæ­¥
              messagesContainer.innerHTML = '';
              result.data.context_messages.forEach(msg => {
                addMessageToUI(msg.content, msg.sender, msg.timestamp);
              });

              // æª¢æŸ¥æœ€å¾Œä¸€æ¢æ˜¯å¦ç‚ºAIå›è¦†
              const lastMessage = result.data.context_messages[result.data.context_messages.length - 1];
              if (lastMessage && lastMessage.sender === 'ai') {
                showStatus('chat-status', 'AI å›è¦†å®Œæˆ', 'success');
                return;
              }
            }
          }

          // ç¹¼çºŒè¼ªè©¢
          attempts++;
          if (attempts < maxAttempts) {
            setTimeout(poll, 1000);
          } else {
            showStatus('chat-status', 'AI å›è¦†è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ Celery Worker ç‹€æ…‹', 'error');
          }
        } catch (error) {
          showStatus('chat-status', `è¼ªè©¢éŒ¯èª¤: ${error.message}`, 'error');
        }
      };

      setTimeout(poll, 2000); // 2ç§’å¾Œé–‹å§‹è¼ªè©¢
    }

    // æ·»åŠ è¨Šæ¯åˆ° UI
    function addMessageToUI(content, senderType, timestamp = null) {
      const messagesContainer = document.getElementById('messages-container');

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${senderType}`;

      const timeStr = timestamp ? new Date(timestamp).toLocaleString() : new Date().toLocaleString();
      const senderName = senderType === 'user' ? 'ğŸ‘¤ æ‚¨' : 'ğŸ¤– AIåŠ©æ‰‹';

      messageDiv.innerHTML = `
    <div class="message-header">${senderName} - ${timeStr}</div>
    <div class="message-content">${content}</div>
  `;

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // åˆªé™¤å°è©±
    async function deleteConversation() {
      if (!currentConversationId) {
        showStatus('chat-status', 'è«‹å…ˆé¸æ“‡å°è©±', 'error');
        return;
      }

      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å°è©±å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/core/conversations/${currentConversationId}/`, {
          method: 'DELETE',
          headers: headers
        });

        if (response.ok) {
          showStatus('chat-status', 'å°è©±åˆªé™¤æˆåŠŸ', 'success');

          // æ¸…é™¤ç•¶å‰å°è©±
          currentConversationId = null;
          document.getElementById('current-conversation').classList.add('hidden');

          // é‡æ–°è¼‰å…¥å°è©±åˆ—è¡¨
          await loadConversations();
        } else {
          const data = await response.json();
          showStatus('chat-status', `åˆªé™¤å¤±æ•—: ${data.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        }
      } catch (error) {
        showStatus('chat-status', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    // Enter éµç™¼é€è¨Šæ¯
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // å¦‚æœå·²æœ‰ tokenï¼Œæ›´æ–° headers ä¸¦é¡¯ç¤ºèŠå¤©å€å¡Š
      if (authToken) {
        updateAuthHeaders();
        document.getElementById('chat-section').classList.remove('hidden');
        loadConversations();
      }
    });
  </script>
{% endblock javascript %}
